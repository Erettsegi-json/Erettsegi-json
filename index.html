<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="description" content="">
<meta name="author" content="Boa">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Érettségi kereső</title>
<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>

<h1><a href="https://erettsegi.boapps.hu">Érettségi kereső</a></h1>
<p id="description">mert az oktatas.hu nem embereknek készült</p>

<div id="selects">
<select id="time"></select>
<select id="level"></select>
<select id="subject"></select>
</div>

<div id="results"></div>

<footer>
<p>Készítette: Boa, </p>
<a href="https://github.com/Erettsegi-json/Erettsegi-json"> forráskód</a>
</footer>

</body>
<script>
let times = new Set();
let levels = new Set();
let subjects = new Set();
let timeSelect = document.getElementById("time");
let levelSelect = document.getElementById("level");
let subjectSelect = document.getElementById("subject");
let resdiv = document.getElementById("results");
let url = new URL(window.location.href);
let resultsNumber = 0;
let frequentSubjects = new Set(["angol nyelv", "biológia", "filozófia", "fizika", "földrajz", "informatika", "kémia", "magyar nyelv és irodalom", "matematika", "német nyelv", "rajz és vizuális kultúra", "spanyol nyelv", "történelem", "ének-zene"]);
let requestURL = 'https://raw.githubusercontent.com/Erettsegi-json/Erettsegi-json/master/erettsegi.json';
let request = new XMLHttpRequest();
request.open('GET', requestURL);
request.responseType = 'text';
request.send();
request.onload = function() {
    const erettsegiResponse = request.response;
    const erettsegiJSON = JSON.parse(erettsegiResponse);
    setSelects(erettsegiJSON);
    refresh(erettsegiJSON, 100);
}

function loadSettings() {
    console.log(url.searchParams.has("time"));
    if (url.searchParams.has("time"))
        timeSelect.value = url.searchParams.get("time");
    if (url.searchParams.has("level"))
        levelSelect.value = url.searchParams.get("level");
    if (url.searchParams.has("subject"))
        subjectSelect.value = url.searchParams.get("subject");
}

function refresh(erettsegiJSON, maxLoad) {
    let results = Array();
    resdiv.innerHTML = '';
    resultsNumber = 0;
    for (i = 0; i < erettsegiJSON.length; i++){
        if (("Bármikor" === times[timeSelect.selectedIndex] || erettsegiJSON[i].time === times[timeSelect.selectedIndex]) && ("Bármelyik szint" === levels[levelSelect.selectedIndex] || erettsegiJSON[i].level === levels[levelSelect.selectedIndex]) && ("Bármelyik tárgy" === subjects[subjectSelect.selectedIndex] || erettsegiJSON[i].subject === subjects[subjectSelect.selectedIndex])) {
            resultsNumber++;
            var card = document.createElement("div");
            card.className = "card";
            var titleParagraph = document.createElement("p");
            titleParagraph.className = "title";
            titleParagraph.innerHTML = erettsegiJSON[i].level + " " + erettsegiJSON[i].subject;
            card.appendChild(titleParagraph);
            
            let column = document.createElement("div");
            column.className = "column";
            
            var left = document.createElement("div");
            let leftHeader = document.createElement("p");
            leftHeader.innerHTML = "feladat";
            leftHeader.className = "header";
            left.appendChild(leftHeader);
            let leftNumber = 0;
            
            var right = document.createElement("div");
            let rightHeader = document.createElement("p");
            rightHeader.innerHTML = "megoldás";
            rightHeader.className = "header";
            right.appendChild(rightHeader);
            let rightNumber = 0;

            column.appendChild(left);
            column.appendChild(right);
            card.appendChild(column);
            for (let link of erettsegiJSON[i].links){
                var linkElement = document.createElement("a");
                var linkParagraph = document.createElement("p");
                linkParagraph.className = "link";
                linkParagraph.appendChild(linkElement);
                if (link.substring(link.lastIndexOf(".")-2, link.lastIndexOf(".")) === "fl") {
                    left.appendChild(linkParagraph);
                    leftNumber++;
                } else {
                    right.appendChild(linkParagraph);
                    rightNumber++;
                }
                linkElement.href = "http://oktatas.hu" + link;
                linkElement.innerHTML = link.substring(link.lastIndexOf("/")+1);
            }
            if (leftNumber === 0)
                left.innerHTML = "";
            if (rightNumber === 0)
                right.innerHTML = "";

            var timeParagraph = document.createElement("p");
            timeParagraph.className = "time";
            timeParagraph.innerHTML = erettsegiJSON[i].time;
            card.appendChild(timeParagraph);
            resdiv.appendChild(card);
            if (resultsNumber >= maxLoad){
                console.log(resultsNumber);
                console.log();
                let moreBtn = document.createElement("button");
                moreBtn.onclick = function(){
                    refresh(erettsegiJSON, resultsNumber + 100);
                };
                moreBtn.innerHTML = "több";
                resdiv.appendChild(moreBtn);
                break;
            }
        }
    }
    if (resultsNumber === 0) {
        resdiv.innerHTML = '<p>Nincs találat</p>';
    }
}

function setSelects(erettsegiJSON) {
    for (i = 0; i < erettsegiJSON.length; i++){
        times.add(erettsegiJSON[i].time);
        levels.add(erettsegiJSON[i].level);
        subjects.add(erettsegiJSON[i].subject);
    }

    times = Array.from(times).sort().reverse();
    levels = Array.from(levels);
    subjects = Array.from(subjects).sort();
    subjects = subjects.filter(subject => !frequentSubjects.has(subject));
    subjects = Array.from(frequentSubjects).concat(subjects);

    timeSelect.addEventListener('change', function() {
        refresh(erettsegiJSON, 100);
        url.searchParams.set("time", times[timeSelect.selectedIndex]);
        window.history.pushState("", "", url.toString());
    });

    subjectSelect.addEventListener('change', function() {
        refresh(erettsegiJSON, 100);
        url.searchParams.set("subject", subjects[subjectSelect.selectedIndex]);
        window.history.pushState("", "", url.toString());
    });

    levelSelect.addEventListener('change', function() {
        refresh(erettsegiJSON, 100);
        url.searchParams.set("level", levels[levelSelect.selectedIndex]);
        window.history.pushState("", "", url.toString());
    });

    times.unshift("Bármikor");
    for (let time of times) {
        timeSelect.options.add(new Option(time, time));
    }

    levels.unshift("Bármelyik szint");
    for (let level of levels) {
        levelSelect.options.add(new Option(level, level));
    }

    subjects.unshift("Bármelyik tárgy");
    for (let subject of subjects) {
        subjectSelect.options.add(new Option(subject, subject));
    }
    loadSettings();
}
</script>
</html>